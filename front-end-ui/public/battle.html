<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle - Neo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        h1 {
            color: #333;
            font-size: 2.5em;
        }
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .battle-setup {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: start;
            margin-bottom: 40px;
        }
        .character-selector {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            border: 2px solid #e9ecef;
        }
        .selector-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .character-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .character-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .character-option:hover:not(.disabled) {
            border-color: #667eea;
            transform: translateX(5px);
        }
        .character-option.selected {
            border-color: #667eea;
            background: #e7f5ff;
        }
        .character-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f0f0f0;
        }
        .character-option-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .character-option-details {
            font-size: 0.85em;
            color: #666;
        }
        .vs-divider {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: #ff6b6b;
            font-weight: bold;
        }
        .battle-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 20px;
        }
        .battle-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
        }
        .battle-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            color: #667eea;
            padding: 40px;
            font-size: 1.2em;
        }
        .error {
            color: #e74c3c;
            background: #fee;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .battle-result {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            display: none;
        }
        .battle-result.show {
            display: block;
        }
        .result-title {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .result-winner {
            color: #51cf66;
        }
        .result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .result-card.winner {
            border-left-color: #51cf66;
        }
        .result-card.loser {
            border-left-color: #ff6b6b;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-info {
            color: #666;
            font-size: 0.9em;
        }
        .battle-log-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .battle-log-item.winner {
            border-left-color: #51cf66;
        }
        .battle-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .battle-log-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }
        .battle-log-date {
            color: #666;
            font-size: 0.9em;
        }
        .battle-log-participants {
            color: #666;
            margin-bottom: 10px;
        }
        .battle-log-summary {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .battle-log-item {
            cursor: pointer;
        }
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .popup-overlay.show {
            display: flex;
        }
        .popup-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            max-height: 80vh;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .popup-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }
        .popup-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s;
        }
        .popup-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .popup-body {
            overflow-y: auto;
            flex: 1;
            padding-right: 10px;
        }
        .popup-battle-log {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .popup-battle-log-item {
            margin: 5px 0;
            color: #666;
            font-size: 0.9em;
        }
        .popup-battle-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .popup-info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .popup-info-card.winner {
            border-left-color: #51cf66;
        }
        .popup-info-card.loser {
            border-left-color: #ff6b6b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è Battle Arena</h1>
            <a href="index.html" class="back-button">‚Üê Home</a>
        </div>

        <div id="loading" class="loading">Loading characters...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="battle-setup" class="battle-setup" style="display: none;">
            <div class="character-selector">
                <div class="selector-title">Select Fighter 1</div>
                <div id="character-list-1" class="character-list"></div>
            </div>

            <div class="vs-divider">
                <div>VS</div>
            </div>

            <div class="character-selector">
                <div class="selector-title">Select Fighter 2</div>
                <div id="character-list-2" class="character-list"></div>
            </div>
        </div>

        <button id="battle-button" class="battle-button" onclick="startBattle()" disabled>
            Run Turn
        </button>

        <div id="battle-result" class="battle-result"></div>

        <div id="battle-logs-section" style="margin-top: 50px; padding-top: 30px; border-top: 2px solid #e9ecef; display: none;">
            <h2 style="color: #333; margin-bottom: 20px;">üìú Battle History</h2>
            <div id="battle-logs-loading" class="loading" style="display: none;">Loading battle logs...</div>
            <div id="battle-logs-error" class="error" style="display: none;"></div>
            <div id="battle-logs-list" style="display: none;"></div>
            <div id="battle-logs-pagination" class="pagination" style="display: none;"></div>
        </div>
    </div>

    <!-- Battle Detail Popup -->
    <div id="battle-popup" class="popup-overlay" onclick="closeBattlePopup(event)">
        <div class="popup-content" onclick="event.stopPropagation()">
            <div class="popup-header">
                <div class="popup-title">‚öîÔ∏è Battle Details</div>
                <button class="popup-close" onclick="closeBattlePopup()">‚úï Close</button>
            </div>
            <div class="popup-body" id="battle-popup-body">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        let allCharacters = [];
        let selectedCharacter1 = null;
        let selectedCharacter2 = null;
        let battleLogsPage = 1;
        const battleLogsLimit = 10;

        function calculateAttackPower(char) {
            // Reduced attack power - divide by 4 to make battles last longer
            const basePower = (char.strength * (1 + char.strength_multiplier)) + 
                             (char.dexterity * (1 + char.dexterity_multiplier));
            return Math.round(basePower / 4);
        }

        async function dealDamage(characterId, damage) {
            const response = await fetch(`${API_URL}/characters/${characterId}/damage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ damage: damage })
            });
            if (!response.ok) {
                throw new Error('Failed to deal damage');
            }
            return await response.json();
        }

        async function addExperience(characterId, amount) {
            const response = await fetch(`${API_URL}/characters/${characterId}/experience`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ amount: amount })
            });
            if (!response.ok) {
                throw new Error('Failed to add experience');
            }
            return await response.json();
        }

        async function refreshCharacter(id) {
            const response = await fetch(`${API_URL}/characters/${id}`);
            if (!response.ok) {
                throw new Error('Failed to refresh character');
            }
            return await response.json();
        }

        async function loadAllCharacters() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const battleSetup = document.getElementById('battle-setup');

            try {
                const response = await fetch(`${API_URL}/characters?page=1&limit=1000`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allCharacters = data.characters || [];

                if (allCharacters.length < 2) {
                    errorDiv.textContent = 'You need at least 2 characters to start a battle. Create more characters first!';
                    errorDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    return;
                }

                displayCharacterLists();
                loadingDiv.style.display = 'none';
                battleSetup.style.display = 'grid';
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = `Error: ${error.message}. Make sure the API is running on ${API_URL}`;
                errorDiv.style.display = 'block';
            }
        }

        function displayCharacterLists() {
            const list1 = document.getElementById('character-list-1');
            const list2 = document.getElementById('character-list-2');

            const characterHTML = (char, listNum, otherSelectedId) => {
                const isDisabled = char.id === otherSelectedId;
                const disabledClass = isDisabled ? 'disabled' : '';
                return `
                    <div class="character-option ${disabledClass}" data-id="${char.id}" data-list="${listNum}" 
                         onclick="${isDisabled ? '' : `selectCharacter('${char.id}', ${listNum})`}" 
                         ${isDisabled ? 'title="Cannot select same character on both sides"' : ''}>
                        <div class="character-option-name">${char.name || 'Unnamed'}</div>
                        <div class="character-option-details">
                            ${char.role} ‚Ä¢ Level ${char.level} ‚Ä¢ ${char.status.toUpperCase()}
                        </div>
                    </div>
                `;
            };

            list1.innerHTML = allCharacters.map(char => characterHTML(char, 1, selectedCharacter2?.id)).join('');
            list2.innerHTML = allCharacters.map(char => characterHTML(char, 2, selectedCharacter1?.id)).join('');
        }

        function selectCharacter(id, listNum) {
            const char = allCharacters.find(c => c.id === id);
            if (!char) return;

            // Prevent selecting same character
            if (listNum === 1 && selectedCharacter2 && selectedCharacter2.id === id) {
                return;
            }
            if (listNum === 2 && selectedCharacter1 && selectedCharacter1.id === id) {
                return;
            }

            document.querySelectorAll(`.character-option[data-list="${listNum}"]`).forEach(el => {
                el.classList.remove('selected');
            });

            const selectedEl = document.querySelector(`.character-option[data-id="${id}"][data-list="${listNum}"]`);
            if (selectedEl) {
                selectedEl.classList.add('selected');
            }

            if (listNum === 1) {
                selectedCharacter1 = char;
            } else {
                selectedCharacter2 = char;
            }

            // Update lists to disable same character in other list
            displayCharacterLists();

            // Re-select the selected characters
            if (selectedCharacter1) {
                const el1 = document.querySelector(`.character-option[data-id="${selectedCharacter1.id}"][data-list="1"]`);
                if (el1) el1.classList.add('selected');
            }
            if (selectedCharacter2) {
                const el2 = document.querySelector(`.character-option[data-id="${selectedCharacter2.id}"][data-list="2"]`);
                if (el2) el2.classList.add('selected');
            }

            const battleButton = document.getElementById('battle-button');
            if (selectedCharacter1 && selectedCharacter2 && selectedCharacter1.id !== selectedCharacter2.id) {
                battleButton.disabled = false;
            } else {
                battleButton.disabled = true;
            }
        }

        async function startBattle() {
            if (!selectedCharacter1 || !selectedCharacter2 || selectedCharacter1.id === selectedCharacter2.id) {
                return;
            }

            const resultDiv = document.getElementById('battle-result');
            const battleButton = document.getElementById('battle-button');

            battleButton.disabled = true;
            resultDiv.innerHTML = '<div class="loading">Battle in progress...</div>';
            resultDiv.classList.add('show');

            try {
                // Refresh characters to get latest data
                let char1 = await refreshCharacter(selectedCharacter1.id);
                let char2 = await refreshCharacter(selectedCharacter2.id);

                const speed1 = char1.speed_modifier;
                const speed2 = char2.speed_modifier;

                // Determine who attacks first - if speeds equal, pick randomly
                let attacker, defender;
                if (speed1 > speed2) {
                    attacker = char1;
                    defender = char2;
                } else if (speed2 > speed1) {
                    attacker = char2;
                    defender = char1;
                } else {
                    // Speeds equal - random choice
                    const random = Math.random();
                    attacker = random > 0.5 ? char1 : char2;
                    defender = attacker.id === char1.id ? char2 : char1;
                }

                const attackPower = calculateAttackPower(attacker);
                let battleLog = [];
                let battleRecorded = false;

                // First attack
                battleLog.push(`${attacker.name} attacks first (Speed: ${attacker.speed_modifier.toFixed(2)} vs ${defender.speed_modifier.toFixed(2)})`);
                battleLog.push(`${attacker.name} deals ${attackPower} damage to ${defender.name}`);

                const damageResult1 = await dealDamage(defender.id, attackPower);
                defender = damageResult1.character;

                if (defender.hp <= 0) {
                    // Attacker wins
                    defender.hp = 0;
                    const expGain = defender.level * 10;
                    const expResult = await addExperience(attacker.id, expGain);
                    attacker = await refreshCharacter(attacker.id);

                    // Record battle
                    battleLog.push(`${defender.name} is defeated!`);
                    battleLog.push(`${attacker.name} gains ${expGain} experience${expResult.leveled_up ? ' and levels up!' : ''}`);
                    await recordBattle(char1.id, char2.id, attacker.id, defender.id, battleLog, expGain, expResult.leveled_up);
                    battleRecorded = true;

                    resultDiv.innerHTML = `
                        <div class="result-title result-winner">üèÜ ${attacker.name} Wins!</div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h3 style="margin-bottom: 10px;">Battle Log:</h3>
                            <ul style="list-style: none; padding: 0;">
                                ${battleLog.map(log => `<li style="margin: 5px 0;">‚Ä¢ ${log}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="result-details">
                            <div class="result-card winner">
                                <h3 style="margin-bottom: 15px; color: #51cf66;">Winner: ${attacker.name}</h3>
                                <p><strong>Role:</strong> ${attacker.role}</p>
                                <p><strong>Level:</strong> ${attacker.level}</p>
                                <p><strong>HP:</strong> ${attacker.hp}/${attacker.max_hp}</p>
                                <p><strong>Speed:</strong> ${attacker.speed_modifier.toFixed(2)}</p>
                                <p><strong>Attack Power:</strong> ${attackPower}</p>
                            </div>
                            <div class="result-card loser">
                                <h3 style="margin-bottom: 15px; color: #ff6b6b;">Loser: ${defender.name}</h3>
                                <p><strong>Role:</strong> ${defender.role}</p>
                                <p><strong>Level:</strong> ${defender.level}</p>
                                <p><strong>HP:</strong> 0/${defender.max_hp}</p>
                                <p><strong>Speed:</strong> ${defender.speed_modifier.toFixed(2)}</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Defender survives, counter-attacks
                    const counterAttackPower = calculateAttackPower(defender);
                    battleLog.push(`${defender.name} survives with ${defender.hp} HP`);
                    battleLog.push(`${defender.name} counter-attacks for ${counterAttackPower} damage`);

                    const damageResult2 = await dealDamage(attacker.id, counterAttackPower);
                    attacker = damageResult2.character;

                    if (attacker.hp <= 0) {
                        // Defender wins
                        attacker.hp = 0;
                        const expGain = attacker.level * 10;
                        const expResult = await addExperience(defender.id, expGain);
                        defender = await refreshCharacter(defender.id);

                        // Record battle
                        battleLog.push(`${attacker.name} is defeated!`);
                        battleLog.push(`${defender.name} gains ${expGain} experience${expResult.leveled_up ? ' and levels up!' : ''}`);
                        await recordBattle(char1.id, char2.id, defender.id, attacker.id, battleLog, expGain, expResult.leveled_up);
                        battleRecorded = true;

                        resultDiv.innerHTML = `
                            <div class="result-title result-winner">üèÜ ${defender.name} Wins!</div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="margin-bottom: 10px;">Battle Log:</h3>
                                <ul style="list-style: none; padding: 0;">
                                    ${battleLog.map(log => `<li style="margin: 5px 0;">‚Ä¢ ${log}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="result-details">
                                <div class="result-card winner">
                                    <h3 style="margin-bottom: 15px; color: #51cf66;">Winner: ${defender.name}</h3>
                                    <p><strong>Role:</strong> ${defender.role}</p>
                                    <p><strong>Level:</strong> ${defender.level}</p>
                                    <p><strong>HP:</strong> ${defender.hp}/${defender.max_hp}</p>
                                    <p><strong>Speed:</strong> ${defender.speed_modifier.toFixed(2)}</p>
                                    <p><strong>Attack Power:</strong> ${counterAttackPower}</p>
                                </div>
                                <div class="result-card loser">
                                    <h3 style="margin-bottom: 15px; color: #ff6b6b;">Loser: ${attacker.name}</h3>
                                    <p><strong>Role:</strong> ${attacker.role}</p>
                                    <p><strong>Level:</strong> ${attacker.level}</p>
                                    <p><strong>HP:</strong> 0/${attacker.max_hp}</p>
                                    <p><strong>Speed:</strong> ${attacker.speed_modifier.toFixed(2)}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        // Both survive - no winner (don't record battle)
                        battleLog.push(`${attacker.name} survives with ${attacker.hp} HP`);
                        battleLog.push(`Both fighters are still standing!`);
                        resultDiv.innerHTML = `
                            <div class="result-title" style="color: #6c757d;">‚öîÔ∏è Both Survive</div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="margin-bottom: 10px;">Battle Log:</h3>
                                <ul style="list-style: none; padding: 0;">
                                    ${battleLog.map(log => `<li style="margin: 5px 0;">‚Ä¢ ${log}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="result-details">
                                <div class="result-card">
                                    <h3 style="margin-bottom: 15px;">${attacker.name}</h3>
                                    <p><strong>HP:</strong> ${attacker.hp}/${attacker.max_hp}</p>
                                    <p><strong>Speed:</strong> ${attacker.speed_modifier.toFixed(2)}</p>
                                </div>
                                <div class="result-card">
                                    <h3 style="margin-bottom: 15px;">${defender.name}</h3>
                                    <p><strong>HP:</strong> ${defender.hp}/${defender.max_hp}</p>
                                    <p><strong>Speed:</strong> ${defender.speed_modifier.toFixed(2)}</p>
                                </div>
                            </div>
                        `;
                    }
                }

                // Reload characters list to show updated stats
                await loadAllCharacters();
                // Reload battle logs (only if a battle was recorded)
                if (battleRecorded) {
                    await loadBattleLogs(battleLogsPage);
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }

            battleButton.disabled = false;
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function recordBattle(char1Id, char2Id, winnerId, loserId, battleLog, expGained, leveledUp) {
            try {
                await fetch(`${API_URL}/battles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        character1_id: char1Id,
                        character2_id: char2Id,
                        winner_id: winnerId,
                        loser_id: loserId,
                        battle_log: battleLog,
                        experience_gained: expGained,
                        leveled_up: leveledUp
                    })
                });
            } catch (error) {
                console.error('Failed to record battle:', error);
            }
        }

        async function loadBattleLogs(page = 1) {
            const logsSection = document.getElementById('battle-logs-section');
            const logsLoading = document.getElementById('battle-logs-loading');
            const logsError = document.getElementById('battle-logs-error');
            const logsList = document.getElementById('battle-logs-list');
            const logsPagination = document.getElementById('battle-logs-pagination');

            try {
                logsLoading.style.display = 'block';
                logsError.style.display = 'none';
                logsList.style.display = 'none';
                logsPagination.style.display = 'none';

                const response = await fetch(`${API_URL}/battles?page=${page}&limit=${battleLogsLimit}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.battles && data.battles.length > 0) {
                    displayBattleLogs(data.battles);
                    displayBattleLogsPagination(data.pagination);
                    logsSection.style.display = 'block';
                } else {
                    logsSection.style.display = 'block';
                    logsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No battle history yet.</p>';
                    logsList.style.display = 'block';
                }

                logsLoading.style.display = 'none';
            } catch (error) {
                logsLoading.style.display = 'none';
                logsError.textContent = `Error: ${error.message}`;
                logsError.style.display = 'block';
            }
        }

        function getBattleSummary(battle) {
            if (!battle.winner_name) {
                return `${battle.character1_name} vs ${battle.character2_name}`;
            }
            const expInfo = battle.experience_gained > 0 ? ` (+${battle.experience_gained} XP${battle.leveled_up ? ', Level Up!' : ''})` : '';
            return `üèÜ ${battle.winner_name} defeated ${battle.loser_name}${expInfo}`;
        }

        function displayBattleLogs(battles) {
            const logsList = document.getElementById('battle-logs-list');
            logsList.innerHTML = battles.map((battle, index) => {
                const date = new Date(battle.timestamp);
                const summary = getBattleSummary(battle);
                return `
                    <div class="battle-log-item ${battle.winner_id ? 'winner' : ''}" data-battle-index="${index}" onclick="showBattleDetailsByIndex(${index})">
                        <div class="battle-log-header">
                            <div class="battle-log-title">${summary}</div>
                            <div class="battle-log-date">${date.toLocaleString()}</div>
                        </div>
                        <div class="battle-log-participants">
                            ${battle.character1_name} vs ${battle.character2_name}
                        </div>
                    </div>
                `;
            }).join('');
            logsList.style.display = 'block';
            // Store battles globally for popup access
            window.currentBattleLogs = battles;
        }

        function showBattleDetailsByIndex(index) {
            if (window.currentBattleLogs && window.currentBattleLogs[index]) {
                showBattleDetails(window.currentBattleLogs[index]);
            }
        }

        function showBattleDetails(battle) {
            const popup = document.getElementById('battle-popup');
            const popupBody = document.getElementById('battle-popup-body');
            const date = new Date(battle.timestamp);

            popupBody.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>Date:</strong> ${date.toLocaleString()}
                </div>
                <div class="popup-battle-info">
                    <div class="popup-info-card ${battle.winner_id === battle.character1_id ? 'winner' : 'loser'}">
                        <h3 style="margin-bottom: 10px;">${battle.character1_name}</h3>
                        <p>${battle.character1_id === battle.winner_id ? 'üèÜ Winner' : 'üíÄ Loser'}</p>
                    </div>
                    <div class="popup-info-card ${battle.winner_id === battle.character2_id ? 'winner' : 'loser'}">
                        <h3 style="margin-bottom: 10px;">${battle.character2_name}</h3>
                        <p>${battle.character2_id === battle.winner_id ? 'üèÜ Winner' : 'üíÄ Loser'}</p>
                    </div>
                </div>
                ${battle.battle_log && battle.battle_log.length > 0 ? `
                    <div class="popup-battle-log">
                        <h3 style="margin-bottom: 10px; color: #333;">Battle Log:</h3>
                        ${battle.battle_log.map(log => `<div class="popup-battle-log-item">‚Ä¢ ${log}</div>`).join('')}
                    </div>
                ` : ''}
                ${battle.experience_gained > 0 ? `
                    <div style="margin-top: 15px; padding: 15px; background: #e7f5ff; border-radius: 8px; border-left: 4px solid #51cf66;">
                        <strong style="color: #51cf66;">Experience Gained:</strong> ${battle.experience_gained}${battle.leveled_up ? ' <span style="color: #339af0;">(Leveled Up!)</span>' : ''}
                    </div>
                ` : ''}
            `;
            popup.classList.add('show');
        }

        function closeBattlePopup(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            document.getElementById('battle-popup').classList.remove('show');
        }

        function displayBattleLogsPagination(pagination) {
            const logsPagination = document.getElementById('battle-logs-pagination');
            const { page, totalPages, total } = pagination;

            logsPagination.innerHTML = `
                <button onclick="changeBattleLogsPage(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
                <span class="pagination-info">Page ${page} of ${totalPages || 1} (${total} total)</span>
                <button onclick="changeBattleLogsPage(${page + 1})" ${page >= totalPages ? 'disabled' : ''}>Next</button>
            `;
            logsPagination.style.display = 'flex';
        }

        function changeBattleLogsPage(page) {
            if (page < 1) return;
            battleLogsPage = page;
            loadBattleLogs(page);
        }

        // Load characters and battle logs on page load
        loadAllCharacters();
        loadBattleLogs(battleLogsPage);
    </script>
</body>
</html>
